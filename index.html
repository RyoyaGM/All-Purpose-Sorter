<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SHISHAMO 楽曲ソーター</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&display=swap" rel="stylesheet">
    <script src="songs.js"></script>
    <style>
        body { font-family: 'M PLUS Rounded 1c', sans-serif; background: linear-gradient(135deg, #a5f3fc, #f9a8d4); }
        .ghost-class { opacity: 0.4; background: #fde047; border: 2px dashed #f97316; }
        .sortable-chosen { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); transform: scale(1.02); cursor: grabbing; }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 10px;}
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .drop-zone { border: 2px dashed #cbd5e1; min-height: 96px; }
        .drop-zone .placeholder-text { color: #94a3b8; }
        .drop-zone.filled { border-style: solid; border-color: #fbcfe8; }
        .palette-item.disabled { opacity: 0.4; pointer-events: none; cursor: not-allowed; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 antialiased">

    <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-7xl">
        <header class="text-center mb-8">
            <h1 class="text-4xl sm:text-5xl font-bold text-pink-500 drop-shadow-md">SHISHAMO 楽曲ソーター</h1>
            <p class="text-lg sm:text-xl text-gray-600 mt-2">My Best SHISHAMO Sorter</p>
            <p class="text-sm text-gray-500 mt-2">左のリストから曲を追加・ドラッグして、右のランキングを完成させよう！</p>
        </header>

        <div class="mb-8 flex flex-col sm:flex-row justify-center gap-2">
            <button id="clear-button" class="bg-gray-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-gray-600 transition-colors shadow-md">ランキングをリセット</button>
            <button id="export-button" class="bg-green-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-600 transition-colors shadow-md">ランキングを出力</button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-1">
                <h2 class="text-2xl font-bold text-center mb-4">曲リスト</h2>
                <div id="song-palette" class="space-y-3 bg-gray-200 p-4 rounded-lg h-[80vh] overflow-y-auto custom-scrollbar"></div>
            </div>
            <div class="lg:col-span-2">
                <h2 class="text-2xl font-bold text-center mb-4">マイランキング</h2>
                <main id="ranking-board" class="space-y-4 h-[80vh] overflow-y-auto custom-scrollbar pr-2"></main>
            </div>
        </div>
        
        <div id="export-container" class="hidden mt-8">
            <h2 class="text-2xl font-bold text-center mb-4">ランキング結果</h2>
            <textarea id="export-textarea" readonly class="w-full h-64 p-3 rounded-lg border-2 border-gray-300 bg-gray-50 font-mono"></textarea>
            <p class="text-center text-sm text-gray-600 mt-2">テキストをコピーして使ってください。</p>
        </div>

        <footer class="text-center mt-12 text-gray-500 text-sm space-y-2">
            <p>&copy; 2025 SHISHAMO 楽曲ソーター</p>
        </footer>
    </div>

    <script>
        const songPaletteElement = document.getElementById('song-palette');
        const rankingBoardElement = document.getElementById('ranking-board');
        const clearButton = document.getElementById('clear-button');
        const exportButton = document.getElementById('export-button');
        const exportContainer = document.getElementById('export-container');
        const exportTextarea = document.getElementById('export-textarea');
        
        const TOTAL_SONGS = shishamoSongs.length;

        // 新しいヘルパー関数: スロットを空の状態に戻す
        const resetSlot = (slot) => {
            const rank = slot.dataset.rank;
            slot.classList.remove('filled');
            // スロット内の全ての子要素を削除
            Array.from(slot.children).forEach(child => child.remove()); 
            slot.innerHTML = `<div class="rank text-2xl font-bold text-pink-400 w-12 text-center flex-shrink-0">${rank}</div>
                              <div class="placeholder-text flex-grow text-center">ここに曲をドラッグ＆ドロップ</div>`;
        }


        const createPaletteItemElement = (song) => {
            const itemEl = document.createElement('div');
            itemEl.className = 'palette-item bg-white p-2 rounded-lg shadow flex items-center space-x-3 cursor-grab active:cursor-grabbing';
            itemEl.setAttribute('data-title', song.title);
            Object.keys(song).forEach(key => itemEl.dataset[key] = song[key]);
            
            // +ボタンを追加
            itemEl.innerHTML = `
                <img src="${song.artwork}" alt="${song.title}" class="w-12 h-12 rounded-md object-cover bg-gray-200 pointer-events-none">
                <div class="flex-grow pointer-events-none">
                    <h4 class="text-sm font-bold text-gray-800">${song.title}</h4>
                    <p class="text-xs text-gray-500">${song.album}</p>
                </div>
                <button class="add-btn bg-pink-500 text-white rounded-full w-8 h-8 flex items-center justify-center hover:bg-pink-600 transition-colors flex-shrink-0" title="ランキングに追加">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                </button>`;

            // +ボタンのクリックイベント
            itemEl.querySelector('.add-btn').addEventListener('click', () => {
                const firstEmptySlot = rankingBoardElement.querySelector('.drop-zone:not(.filled)');
                if (firstEmptySlot) {
                    const songData = itemEl.dataset;
                    const newRankedItem = createRankedItemElement(songData);
                    
                    firstEmptySlot.querySelector('.placeholder-text')?.remove();
                    firstEmptySlot.appendChild(newRankedItem);
                    firstEmptySlot.classList.add('filled');
                    
                    itemEl.classList.add('disabled');
                } else {
                    alert('ランキングに空きがありません。');
                }
            });

            return itemEl;
        };

        const createRankedItemElement = (song) => {
             const itemEl = document.createElement('div');
             itemEl.className = 'ranked-item bg-white p-2 rounded-lg shadow-md flex items-center space-x-2 w-full cursor-grab active:cursor-grabbing';
             itemEl.setAttribute('data-title', song.title);
             itemEl.dataset.artwork = song.artwork;
             itemEl.dataset.album = song.album;
             itemEl.innerHTML = `
                <img src="${song.artwork}" alt="${song.title}" class="w-16 h-16 rounded-lg object-cover shadow-sm bg-gray-200">
                <div class="flex-grow">
                    <h3 class="text-lg font-bold text-gray-800">${song.title}</h3>
                    <p class="text-sm text-gray-500">${song.album}</p>
                </div>
                <button class="delete-btn text-gray-300 hover:text-red-500 transition-colors p-1" title="削除">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>`;
            
            itemEl.querySelector('.delete-btn').addEventListener('click', (e) => {
                const parentSlot = e.currentTarget.closest('.drop-zone');
                const songTitle = itemEl.dataset.title;
                const paletteItem = songPaletteElement.querySelector(`[data-title="${songTitle}"]`);
                if (paletteItem) paletteItem.classList.remove('disabled');

                resetSlot(parentSlot); // ヘルパー関数に変更
            });
            return itemEl;
        }

        const initializeApp = () => {
            songPaletteElement.innerHTML = '';
            rankingBoardElement.innerHTML = '';
            shishamoSongs.forEach(song => songPaletteElement.appendChild(createPaletteItemElement(song)));
            for (let i = 1; i <= TOTAL_SONGS; i++) {
                const slotEl = document.createElement('div');
                slotEl.className = 'drop-zone flex items-center p-2 rounded-lg transition-colors';
                slotEl.setAttribute('data-rank', i);
                slotEl.innerHTML = `<div class="rank text-2xl font-bold text-pink-400 w-12 text-center flex-shrink-0">${i}</div>
                                    <div class="placeholder-text flex-grow text-center">ここに曲をドラッグ＆ドロップ</div>`;
                rankingBoardElement.appendChild(slotEl);
            }
            setupSortable();
        };

        const clearList = () => { if (confirm('本当にランキングをすべてリセットしますか？')) initializeApp(); };
        
        const exportListAsText = () => {
            const rankedItems = rankingBoardElement.querySelectorAll('.ranked-item');
            if (rankedItems.length === 0) { alert('ランキングが空です。'); return; }
            let outputString = 'わたしのSHISHAMO楽曲ランキング\n========================\n';
            rankingBoardElement.querySelectorAll('.drop-zone').forEach(slot => {
                const rankedItem = slot.querySelector('.ranked-item');
                if(rankedItem){
                    const rank = slot.dataset.rank;
                    const title = rankedItem.getAttribute('data-title');
                    outputString += `${rank}. ${title}\n`;
                }
            });
            outputString += '========================\n#SHISHAMO楽曲ソーター で作成\n';
            exportTextarea.value = outputString;
            exportContainer.classList.remove('hidden');
            exportContainer.scrollIntoView({ behavior: 'smooth' });
        };
        
        // SortableJSの初期化を関数にまとめる
        const setupSortable = () => {
            new Sortable(songPaletteElement, {
                group: { name: 'shishamo-songs', pull: 'clone', put: false },
                sort: false,
                animation: 150,
                filter: '.disabled',
            });
            
            const slots = Array.from(rankingBoardElement.querySelectorAll('.drop-zone'));

            slots.forEach(slot => {
                new Sortable(slot, {
                    group: { name: 'shishamo-songs', pull: true, put: true },
                    animation: 150,
                    draggable: '.ranked-item', 
                    onAdd: function(evt) {
                        const droppedItem = evt.item; 
                        const targetSlot = evt.to;   
                        const targetRank = parseInt(targetSlot.dataset.rank);
                        const isFromPalette = evt.from === songPaletteElement;
                        
                        // --- 1. ターゲットスロットの既存曲データを取得し、スロットを完全にクリーンアップ ---
                        
                        // Sortableが挿入した要素(droppedItem)以外で、既にスロット内にあった ranked-item のデータを取得
                        const existingItem = Array.from(targetSlot.querySelectorAll('.ranked-item')).find(item => item !== droppedItem && !item.classList.contains('sortable-ghost'));
                        
                        let displacedItemData = existingItem ? existingItem.dataset : null;
                        
                        // ターゲットスロット内の全ての要素を削除（これにより重複が解消される）
                        Array.from(targetSlot.children).forEach(child => child.remove()); 

                        // --- 2. 新しい曲を挿入 ---
                        const newSongData = {
                            title: droppedItem.dataset.title,
                            album: droppedItem.dataset.album,
                            artwork: droppedItem.dataset.artwork
                        };
                        
                        targetSlot.appendChild(createRankedItemElement(newSongData));
                        targetSlot.classList.add('filled');
                        
                        // --- 3. 移動元スロットの処理 ---
                        if (isFromPalette) {
                            // パレットからの追加の場合、パレットの曲を無効化
                            songPaletteElement.querySelector(`[data-title="${newSongData.title}"]`)?.classList.add('disabled');
                        } else {
                             // ランキング内での移動の場合、移動元スロットをリセット
                            const sourceSlot = evt.from;
                            // SortableJSによって要素が削除された後、スロットを空の状態にリセット
                            if (!sourceSlot.querySelector('.ranked-item')) {
                                resetSlot(sourceSlot);
                            }
                        }

                        // --- 4. 押し出し処理（カスケードシフト） ---
                        if (displacedItemData) {
                            let itemToPush = displacedItemData;

                            for (let i = targetRank; i < slots.length; i++) {
                                const nextSlot = slots[i]; 
                                
                                // nextSlotに元々入っていた曲のデータを取得
                                const nextItem = nextSlot.querySelector('.ranked-item');
                                let itemToBeDisplaced = nextItem ? nextItem.dataset : null; 
                                
                                // itemToPush を nextSlot に配置
                                Array.from(nextSlot.children).forEach(child => child.remove()); // nextSlot内を完全にクリア
                                nextSlot.appendChild(createRankedItemElement(itemToPush));
                                nextSlot.classList.add('filled');
                                
                                itemToPush = itemToBeDisplaced;

                                if (!itemToPush) {
                                    break;
                                }
                            }
                            
                            // 5. 最後まで押し出された曲があれば、パレットに戻す
                            if (itemToPush) {
                                songPaletteElement.querySelector(`[data-title="${itemToPush.title}"]`)?.classList.remove('disabled');
                                
                                const lastSlotIndex = slots.length - 1;
                                resetSlot(slots[lastSlotIndex]);
                            }
                        }
                    },
                    // onRemove: ランキング内の曲が移動元スロットから削除されたときに発火
                    onRemove: function(evt) {
                        // onAdd側でリセット処理が成功していれば、ここでは特に何もしない
                    }
                });
            });
        };

        document.addEventListener('DOMContentLoaded', initializeApp);
        clearButton.addEventListener('click', clearList);
        exportButton.addEventListener('click', exportListAsText);
    </script>
</body>
</html>
